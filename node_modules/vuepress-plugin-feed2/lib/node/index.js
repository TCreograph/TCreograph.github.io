import{colors as y,fs as F,path as T}from"@vuepress/utils";import{isLinkHttp as I,removeEndingSlash as D,removeLeadingSlash as k,isArray as j,isFunction as g,isPlainObject as U}from"@vuepress/shared";import{Logger as G,deepMerge as H,encodeXML as m,encodeCDATA as C,stripTags as L,isUrl as $,getPageText as K,getAuthor as N,getCategory as W,getPageExcerpt as q,isAbsoluteUrl as A}from"vuepress-shared/node";import{js2xml as R}from"xml-js";const P="vuepress-plugin-feed2",v=new G(P),M=(i,t)=>!i||!(i instanceof Date)?1:!t||!(t instanceof Date)?-1:t.getTime()-i.getTime(),b=(i,t="",e="")=>`${I(i)?D(i):`https://${D(i)}`}${t}${k(e)}`,B=(i="")=>`image/${i==="jpg"?"jpeg":i==="svg"?"svg+xml":i==="jpeg"||i==="png"||i==="bmp"||i==="gif"||i==="webp"?i:""}`,X=(i,t,e="",a="")=>{t in i&&(v.error(`"${y.magenta(t)}" is ${y.red("removed")}${a?`, please use ${y.magenta(a)} instead.`:" and no longer supported"}${e?`
${e}`:""}`),a||delete i[t])},z=i=>{var t,e,a,r,n,s,o,u,l,p,d,h;i.atom=((e=(t=i.output)==null?void 0:t.atom)==null?void 0:e.enable)??!0,i.json=((r=(a=i.output)==null?void 0:a.json)==null?void 0:r.enable)??!0,i.rss=((s=(n=i.output)==null?void 0:n.rss)==null?void 0:s.enable)??!0,i.atomOutputFilename=((u=(o=i.output)==null?void 0:o.atom)==null?void 0:u.path)??"atom.xml",i.jsonOutputFilename=((p=(l=i.output)==null?void 0:l.json)==null?void 0:p.path)??"feed.json",i.jsonOutputFilename=((h=(d=i.output)==null?void 0:d.rss)==null?void 0:h.path)??"rss.xml",X(i,"output")},Q=i=>i.hostname?(i.hostname=I(i.hostname)?D(i.hostname):`https://${D(i.hostname)}`,!0):!1,V=i=>i.locales&&Object.entries(i.locales).some(([,{atom:t,json:e,rss:a}])=>t||e||a)||Boolean(i.atom||i.json||i.rss),Y=({siteData:i},t)=>Object.fromEntries(Object.keys({"/":{},...i.locales}).map(e=>{var a;return[e,{filter:({frontmatter:r,filePathRelative:n})=>!(r.home||!n||r.article===!1||r.feed===!1),sorter:(r,n)=>{var s,o,u,l;return M((s=r.data.git)!=null&&s.createdTime?new Date((o=r.data.git)==null?void 0:o.createdTime):r.frontmatter.date,(u=n.data.git)!=null&&u.createdTime?new Date((l=n.data.git)==null?void 0:l.createdTime):n.frontmatter.date)},...t,...(a=t.locales)==null?void 0:a[e],hostname:t.hostname}]})),Z=(i,t,e="")=>{var a,r,n,s,o,u,l;const{base:p}=i.options,{title:d,description:h,lang:f,locales:c}=i.siteData,{hostname:_,icon:O,image:E}=t,x=(r=(a=t.channel)==null?void 0:a.author)==null?void 0:r.name,J={title:((n=c[e])==null?void 0:n.title)||d||((s=c["/"])==null?void 0:s.title)||"",link:b(_,p,e),description:((o=c[e])==null?void 0:o.description)||h||((u=c["/"])==null?void 0:u.description)||"",language:((l=c[e])==null?void 0:l.lang)||f,copyright:x?`Copyright by ${x}`:"",pubDate:new Date,lastUpdated:new Date,...O?{icon:O}:{},...E?{image:E}:{},...x?{author:{name:x}}:{}};return H(J,t.channel||{})},w=(i,t="/")=>({atomOutputFilename:`${k(t)}${i.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${k(t)}${i.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${k(t)}${i.rssOutputFilename||"rss.xml"}`}),tt=({options:{base:i}},t)=>{const{hostname:e}=t,{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:n}=w(t);return{atom:b(e,i,a),json:b(e,i,r),rss:b(e,i,n)}},et=(i,t)=>{const{base:e}=i.options,{siteData:a}=i,r=Object.keys(t);if(r.length===1){const{atomOutputFilename:n,jsonOutputFilename:s,rssOutputFilename:o}=w(t["/"]),{atom:u,json:l,rss:p,hostname:d}=t["/"],h=(f,c,_)=>{var O;return["link",{rel:"alternate",type:_,href:b(d,e,c),title:`${a.title||((O=a.locales["/"])==null?void 0:O.title)||""} ${f} Feed`}]};a.head||(a.head=[]),u&&a.head.push(h("Atom",n,"application/atom+xml")),l&&a.head.push(h("JSON",s,"application/json")),p&&a.head.push(h("RSS",o,"application/rss+xml"))}else i.pages.forEach(n=>{const{pathLocale:s}=n,o=t[s];if(r.includes(s)){const{atomOutputFilename:u,jsonOutputFilename:l,rssOutputFilename:p}=w(o,s),d=(h,f,c)=>{var _,O;return["link",{rel:"alternate",type:c,href:b(o.hostname,e,f),title:`${((_=a.locales[s])==null?void 0:_.title)||a.title||((O=a.locales["/"])==null?void 0:O.title)||""} ${h} Feed`}]};n.frontmatter.head||(n.frontmatter.head=[]),o.atom&&n.frontmatter.head.push(d("Atom",u,"application/atom+xml")),o.json&&n.frontmatter.head.push(d("JSON",l,"application/json")),o.rss&&n.frontmatter.head.push(d("RSS",p,"application/rss+xml"))}})},S=i=>{const{name:t="Unknown",email:e,url:a}=i;return{name:t,...e?{email:e}:{},...a?{uri:m(a)}:{}}},it=i=>{const{name:t,scheme:e=""}=i;return{_attributes:{term:t,scheme:e}}},nt=i=>{const{channel:t,links:e}=i.options,a={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:S(t.author)}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:P,link:[{_attributes:{rel:"self",href:m(e.atom)}}]}};return t.link&&a.feed.link.push({_attributes:{rel:"alternate",href:m(t.link)}}),t.hub&&a.feed.link.push({_attributes:{rel:"hub",href:m(t.hub)}}),t.image&&(a.feed.logo=t.image),t.icon&&(a.feed.icon=t.icon),t.copyright&&(a.feed.rights=t.copyright),a.feed.category=Array.from(i.categories).map(r=>({_attributes:{term:r}})),a.feed.contributor=Array.from(i.contributors).filter(r=>r.name).map(r=>S(r)),a.feed.entry=i.items.map(r=>{const n={title:{_attributes:{type:"html"},_text:m(r.title)},id:m(r.guid||r.link),link:{_attributes:{href:m(r.link)}},updated:r.lastUpdated.toISOString()};return r.description&&(n.summary=r.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:C(r.description.substring(5))}:{_attributes:{type:"html"},_text:r.description}),r.content&&(n.content={_attributes:{type:"html"},_cdata:C(r.content)}),r.author&&(n.author=r.author.filter(s=>s.name).map(s=>S(s))),r.category&&(n.category=r.category.map(s=>it(s))),r.contributor&&(n.contributor=r.contributor.map(s=>S(s))),r.pubDate&&(n.published=r.pubDate.toISOString()),r.copyright&&(n.rights=r.copyright),n}),R(a,{compact:!0,ignoreComment:!0,spaces:2})},at=i=>({name:i.name,...i.url?{url:i.url}:{},...i.avatar?{avatar:i.avatar}:{}}),rt=i=>{var t;const{channel:e,links:a}=i.options,r={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:a.json};return e.description&&(r.description=e.description),e.image&&(r.icon=e.image),e.icon&&(r.favicon=e.icon),(t=e.author)!=null&&t.name&&(r.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avatar?{avatar:e.author.avatar}:{}}),r.items=i.items.map(n=>{const s={title:n.title,url:n.link,id:n.guid||n.link,...n.description?{summary:n.description.startsWith("html:")?L(n.description.substring(5)):n.description}:{},content_html:n.content};return n.image&&(s.image=n.image),n.pubDate&&(s.date_published=n.pubDate.toISOString()),n.lastUpdated&&(s.date_modified=n.lastUpdated.toISOString()),j(n.author)&&(s.authors=n.author.filter(o=>o.name).map(o=>at(o))),n.category&&(s.tags=n.category.filter(o=>o.name).map(o=>o.name)),s}),JSON.stringify(r,null,2)},st=i=>{const{name:t,domain:e}=i;return{_text:t,...e?{_attributes:{domain:e}}:{}}},ot=i=>{const t=i.guid||m(i.link);return{...$(t)?{}:{_attributes:{isPermaLink:!1}},_text:t}},lt=i=>({_attributes:{url:i.url,...i.length?{length:i.length}:{},...i.type?{type:i.type}:{}}}),ut=i=>{const{links:t,channel:e}=i.options;let a=!1;const r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:e.title},link:{_text:m(e.link)},description:{_text:e.description},language:{_text:m(e.language)},pubDate:{_text:e.pubDate?e.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:e.lastUpdated?e.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:P},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return e.copyright&&(r.rss.channel.copyright={_text:e.copyright}),e.ttl&&(r.rss.channel.ttl={_text:e.ttl.toString()}),e.image&&(r.rss.channel.image={title:{_text:e.title},url:{_text:e.image},link:{_text:m(e.link)}}),r.rss.channel.category=Array.from(i.categories).map(n=>({_text:n})),r.rss.channel.item=i.items.map(n=>{const s={title:{_text:m(n.title)},link:{_text:m(n.link)},guid:ot(n),source:{_attributes:{url:t.rss},_text:n.title}};if(n.description&&(s.description={_text:n.description.startsWith("html:")?L(n.description.substring(5)):n.description}),n.author){const o=n.author.find(u=>u.email&&u.name);o&&(s.author={_text:`${o.email} (${o.name})`})}return n.category&&(s.category=n.category.filter(o=>o.name).map(o=>st(o))),n.comments&&(s.comments={_text:m(n.link)}),n.pubDate&&(s.pubDate={_text:n.pubDate.toUTCString()}),n.content&&(a=!0,s["content:encoded"]={_cdata:C(n.content)}),n.enclosure&&(s.enclosure=lt(n.enclosure)),s}),a&&(r.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",r.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),R(r,{compact:!0,ignoreComment:!0,spaces:2})};class pt{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=e=>{this.items.push(e)},this.addCategory=e=>{this.categories.add(e)},this.addContributor=e=>{const a=e.email||e.name;a&&!this._contributorKeys.has(a)&&(this._contributorKeys.add(a),this.contributors.push(e))},this.atom=()=>nt(this),this.rss=()=>ut(this),this.json=()=>rt(this)}}class ht{constructor(t,e,a,r){this.app=t,this.options=e,this.page=a,this.feed=r,this.base=this.app.options.base,this.frontmatter=a.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return g(this.getter.title)?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return g(this.getter.link)?this.getter.link(this.page):b(this.options.hostname,this.base,this.page.path)}get description(){if(g(this.getter.description))return this.getter.description(this.page);if(this.pageFeedOptions.description)return this.pageFeedOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=K(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){var t,e;return g(this.getter.author)?this.getter.author(this.page):j(this.pageFeedOptions.author)?this.pageFeedOptions.author:U(this.pageFeedOptions.author)?[this.pageFeedOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?N(this.frontmatter.author):(t=this.options.channel)!=null&&t.author?N((e=this.options.channel)==null?void 0:e.author):[]}get category(){if(g(this.getter.category))return this.getter.category(this.page);if(j(this.pageFeedOptions.category))return this.pageFeedOptions.category;if(U(this.pageFeedOptions.category))return[this.pageFeedOptions.category];const{categories:t,category:e=t}=this.frontmatter;return W(e).map(a=>({name:a}))}get enclosure(){return g(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:B(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if(g(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:a}=this.page.data.git||{};return e&&e instanceof Date?e:a?new Date(a):null}get lastUpdated(){if(g(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return g(this.getter.content)?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:q(this.app,this.page,{excerptLength:1/0})}get image(){if(g(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:e}=this.frontmatter;if(t){if(A(t))return b(this.options.hostname,this.app.options.base,t);if($(t))return t}if(e){if(A(e))return b(this.options.hostname,this.app.options.base,e);if($(e))return e}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(A(a[1]))return b(this.options.hostname,this.app.options.base,a[1]);if($(a[1]))return a[1]}return null}get contributor(){return g(this.getter.contributor)?this.getter.contributor(this.page):j(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:U(this.pageFeedOptions.contributor)?[this.pageFeedOptions.contributor]:this.author}get copyright(){if(g(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t!=null&&t.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:a,contributor:r,copyright:n,description:s,enclosure:o,guid:u,image:l,lastUpdated:p,link:d,pubDate:h,title:f}=this;return!f&&!s?null:(e&&e.forEach(c=>this.feed.addCategory(c.name)),r&&r.forEach(c=>this.feed.addContributor(c)),{title:f,link:d,guid:u,lastUpdated:p,content:a,author:t,contributor:r,...s?{description:s}:{},...e?{category:e}:{},...o?{enclosure:o}:{},...h?{pubDate:h}:{},...l?{image:l}:{},...n?{copyright:n}:{}})}}class ct{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map(([a,r])=>[a,new pt({channel:Z(t,r,a),links:tt(t,r)})]))}addPages(t){const e=this.feedMap[t],a=this.options[t],{count:r=100,filter:n=({frontmatter:l,filePathRelative:p})=>!(l.home||!p||l.article===!1||l.feed===!1),sorter:s=(l,p)=>{var d,h,f,c;return M((d=l.data.git)!=null&&d.createdTime?new Date((h=l.data.git)==null?void 0:h.createdTime):l.frontmatter.date,(f=p.data.git)!=null&&f.createdTime?new Date((c=p.data.git)==null?void 0:c.createdTime):p.frontmatter.date)}}=a,o=this.app.pages.filter(l=>l.pathLocale===t).filter(n).sort(s).slice(0,r);let u=0;for(const l of o){const p=new ht(this.app,a,l,e).getFeedItem();p&&(e.addItem(p),u+=1)}v.succeed(`added ${y.cyan(`${u} page${u>1?"s":""}`)} as feed item${u>1?"s":""} in route ${y.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all(Object.entries(this.options).map(async([e,a])=>{if(a.atom||a.json||a.rss){const r=this.feedMap[e],{atomOutputFilename:n,jsonOutputFilename:s,rssOutputFilename:o}=w(a,e);this.addPages(e),a.atom&&(await F.ensureDir(T.dirname(t(n))),await F.outputFile(t(n),r.atom()),v.succeed(`Atom feed file generated and saved to ${y.cyan(`/${n}`)}`)),a.json&&(await F.ensureDir(T.dirname(t(s))),await F.outputFile(t(s),r.json()),v.succeed(`JSON feed file generated and saved to ${y.cyan(`${s}`)}`)),a.rss&&(await F.ensureDir(T.dirname(t(o))),await F.outputFile(t(o),r.rss()),v.succeed(`RSS feed file generated and saved to ${y.cyan(`${o}`)}`))}}))}}const dt=(i,t=!1)=>e=>{t&&z(i),e.env.isDebug&&v.info("Options:",i);const a={name:"vuepress-plugin-feed2"};if(!Q(i))return v.error(`Option ${y.magenta("hostname")} is required!`),a;if(!V(i))return v.info("No requested output, the plugin won’t start!"),a;const r=Y(e,i);return{...a,onPrepared:n=>et(n,r),onGenerated:async n=>{await new ct(n,r).generateFeed()}}};export{dt as feedPlugin};
//# sourceMappingURL=index.js.map

"use strict";var v=require("node:fs"),h=require("upath");const w=/\r\n?|\n/g,_=e=>{const r=e.split(`
`),l=r.reduce((o,t)=>{for(let n=0;n<t.length;n++)if(t[n]!==" "&&t[n]!=="	")return Math.min(n,o);return o},1/0);return l<1/0?r.map(o=>o.slice(l)).join(`
`):e},E=[/^\/\/ ?#?((?:end)?region) ([\w*-]+)$/,/^\/\* ?#((?:end)?region) ([\w*-]+) ?\*\/$/,/^#pragma ((?:end)?region) ([\w*-]+)$/,/^<!-- #?((?:end)?region) ([\w*-]+) -->$/,/^#((?:End )Region) ([\w*-]+)$/,/^::#((?:end)region) ([\w*-]+)$/,/^# ?((?:end)?region) ([\w*-]+)$/],I=/^@include\(([^)]+(?:\.[a-z0-9]+))(?:#([\w-]+))?(?:\{(\d+)?-(\d+)?\})?\)$/,P=(e,r,l,o=!1)=>{const[t,n,c]=r.exec(e.trim())||[];return Boolean(t&&n&&c===l&&n.match(o?/^[Ee]nd ?[rR]egion$/:/^[rR]egion$/))},S=(e,r)=>{let l=null,o=-1;for(const[t,n]of e.entries())if(l===null){for(const c of E)if(P(n,c,r)){o=t+1,l=c;break}}else if(P(n,l,r,!0))return{lineStart:o,lineEnd:t};return null},$=(e,{cwd:r,includedFiles:l,resolvedPath:o})=>{const{filePath:t}=e;let n=t;if(!h.isAbsolute(t)){if(!r)return console.error(`[@mdit/plugin-include]: Error when resolving path: ${t}`),`
Error when resolving path
`;n=h.resolve(r,t)}if(l.push(n),!v.existsSync(n))return console.error(`[@mdit/plugin-include]: ${n} not found`),`
File not found
`;const c=v.readFileSync(n).toString().replace(w,`
`).split(`
`);let s=[];if("region"in e){const i=S(c,e.region);i&&(s=c.slice(i.lineStart,i.lineEnd))}else{const{lineStart:i,lineEnd:u}=e;s=c.slice(i&&i-1,u)}if(o&&n.endsWith(".md")){const i=h.dirname(n);s.unshift(`@include-push(${i})`),s.push("@include-pop()")}return _(s.join(`
`).replace(/\n?$/,`
`))},g=(e,r,{cwd:l,includedFiles:o})=>e.split(`
`).map(t=>{if(t.startsWith("@include")){const n=t.match(I);if(n){const[,c,s,i,u]=n,d=r.resolvePath(c,l),a=r.resolveImagePath||r.resolveLinkPath,p=$({filePath:d,...s?{region:s}:{lineStart:i?Number(i):0,lineEnd:u?Number(u):void 0}},{cwd:l,includedFiles:o,resolvedPath:a});return r.deep&&d.endsWith(".md")?g(p,r,{cwd:h.isAbsolute(d)?h.dirname(d):l?h.resolve(l,h.dirname(d)):null,includedFiles:o}):p}}return t}).join(`
`),k=e=>r=>{const l=r.env,o=l.includedFiles||(l.includedFiles=[]),t=e.currentPath(l);r.src=g(r.src,e,{cwd:t?h.dirname(t):null,includedFiles:o})},F=/^@include-push\(([^)]*?)\)$/,y=/^@include-pop\(\)$/,R=(e,r,l,o)=>{const t=e.bMarks[r]+e.tShift[r],n=e.eMarks[r],c=e.src.slice(t,n);let s=c.startsWith("@include-push");if(s){const i=c.match(F);if(i){if(o)return!0;const[,u]=i;e.line=r+1;const d=e.push("include_push","",0);d.map=[r,e.line],d.info=u,d.markup="include_push"}else s=!1}return s},W=(e,r,l,o)=>{const t=e.bMarks[r]+e.tShift[r],n=e.eMarks[r],c=e.src.slice(t,n);let s=c.startsWith("@include-pop");if(s)if(c.match(y)){if(o)return!0;e.line=r+1;const i=e.push("include_pop","",0);i.map=[r,e.line],i.markup="include_pop"}else s=!1;return s},b=(e,r,l,o)=>{var t;const n=r.attrIndex(e),c=(t=r.attrs)==null?void 0:t[n][1];if(c!=null&&c.startsWith(".")&&Array.isArray(o)){const{length:s}=o;if(s){const i=h.relative(h.dirname(l),o[s-1]);r.attrs[n][1]=`.${h.sep}${h.join(i,c)}`}}},A=(e,r)=>{const{currentPath:l,resolvePath:o=s=>s,deep:t=!1,resolveLinkPath:n=!0,resolveImagePath:c=!0}=r||{};if(typeof l!="function")return console.error('[@mdit/plugin-include]: "currentPath" is required');if(e.core.ruler.after("normalize","md_import",k({currentPath:l,resolvePath:o,deep:t,resolveLinkPath:n,resolveImagePath:c})),c||n){if(e.block.ruler.before("table","md_include_push",R,{alt:["paragraph","reference","blockquote","list"]}),e.block.ruler.before("table","md_include_pop",W,{alt:["paragraph","reference","blockquote","list"]}),e.renderer.rules.include_push=(s,i,u,d)=>{const a=s[i];return(d.includedPaths??(d.includedPaths=[])).push(a.info),""},e.renderer.rules.include_pop=(s,i,u,d)=>{const a=d.includedPaths;return Array.isArray(a)?a.pop():console.error("[@mdit/plugin-include]: include_pop failed, no include_push."),""},c){const s=e.renderer.rules.image;e.renderer.rules.image=(i,u,d,a,p)=>{const m=i[u],f=l(a);return f&&b("src",m,f,a.includedPaths),s(i,u,d,a,p)}}if(n){const s=e.renderer.rules.link_open||((i,u,d,a,p)=>p.renderToken(i,u,d));e.renderer.rules.link_open=(i,u,d,a,p)=>{const m=i[u],f=l(a);return f&&b("href",m,f,a.includedPaths),s(i,u,d,a,p)}}}};exports.createIncludeCoreRule=k,exports.handleInclude=$,exports.include=A,exports.resolveInclude=g;
//# sourceMappingURL=index.cjs.map
